USE [SIMADB]
GO
/****** Object:  StoredProcedure [dbo].[SP_ServiceCatalog_ServiceNetworkDiagram]    Script Date: 2024/Dec/01 9:55:43 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Adineh,,Name>
-- Create date: <14030814,,>
-- Description:	<Description,,>
--LastUpdate 14030825
-- =============================================
--exec  [dbo].[SP_ServiceCatalog_ServiceNetworkDiagram] 4036569674,1 
ALTER  PROCEDURE [dbo].[SP_ServiceCatalog_ServiceNetworkDiagram](@id as bigint=null,@type as int=null)

AS
BEGIN

	SET NOCOUNT ON;

	declare @str as nvarchar(max);
	declare @color as nvarchar(20);
	set @color=(select color from Basic.BusinessEntity	where id=@type);

	;WITH CTE AS (
 SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) AS rowid, * 
 from 
 (  select * from ( SELECT distinct
        Id,
        Name,
        0 ParentId,
		 0 AS Level
		 ,'Red' color
    FROM [SIMADB].ServiceCatalog.Product
    WHERE (id=@id or @id IS NULL) and ActiveStatusId<>3

    UNION all
  
	  SELECT distinct
        c.Id,
        c.Name,
        s.Id ParentId,
		 1 AS Level
		  ,'Green' color
     FROM [SIMADB].ServiceCatalog.Product S
    INNER JOIN [SIMADB].ServiceCatalog.ProductChannel st ON s.id = st.ProductId 
	 INNER JOIN [SIMADB].ServiceCatalog.Channel C ON c.id = st.ChannelId 
	where  st.ActiveStatusId<>3 and ( st.ProductId =@id or  @id is null)) as t1

	UNION

  select * from (   SELECT distinct
        Id,
        Name,
        0 ParentId,
		 0 AS Level
		 ,'Green' color
    FROM [SIMADB].ServiceCatalog.Channel
    WHERE (id=@id or @id IS NULL) and ActiveStatusId<>3

    UNION ALL
  
	  SELECT distinct
        c.Id,
        c.Name,
        s.Id ParentId,
		 1 AS Level
		,'Blue' color
     FROM [SIMADB].ServiceCatalog.Channel C
    INNER JOIN [SIMADB].ServiceCatalog.ServiceChanel  SC ON C.id = SC.ChannelId
	 INNER JOIN [SIMADB].ServiceCatalog.Service S ON S.id = SC.ServiceId
	where  SC.ActiveStatusId<>3 and  (SC.ChannelId =@id or  @id is null)) as t2

union

select * from ( 

    SELECT distinct
        Id,
        Name,
        0 ParentId,
		 0 AS Level
       ,'Blue' color
    FROM [SIMADB].ServiceCatalog.Service
    WHERE (id=@id or @id IS NULL) and ActiveStatusId<>3

    UNION ALL
  
	  SELECT distinct
        s.Id,
        s.Name,
        sa.Id ParentId,
		 1 AS Level
		 ,'Yellow' color
     FROM   [SIMADB].ServiceCatalog.Service AS S 
	  INNER JOIN [SIMADB]. ServiceCatalog.ServiceAsset  SA ON S.id = SA.ServiceId
	  INNER JOIN [SIMADB].AssetAndConfiguration.Asset AS A ON SA.AssetId = A.Id
 	where  Sa.ActiveStatusId<>3 and  (SA.ServiceId =@id or  @id is null)) as t3

	UNION

select * from (	SELECT distinct
        Id,
        A.Title Name,
        0 ParentId,
		 0 AS Level
		  ,'Yellow' color
    FROM [SIMADB].AssetAndConfiguration.Asset AS A
    WHERE (id=@id or @id IS NULL) and ActiveStatusId<>3

    UNION ALL
  
	  SELECT distinct
        A.Id,
        A.Title as Name,
        CI.Id  ParentId,
		 1 AS Level
		  ,'Purple' color
     FROM [SIMADB].AssetAndConfiguration.Asset AS A  
	 inner  JOIN  AssetAndConfiguration.ConfigurationItemAsset AS A2 ON A.Id = A2.AssetId
	 inner  JOIN  AssetAndConfiguration.ConfigurationItemVersioning AS CIV ON A2.ConfigurationItemVersioningId = CIV.Id
	 inner  JOIN   AssetAndConfiguration.ConfigurationItem AS CI ON CIV.ConfigurationItemId = CI.Id 
	where  CIV.ActiveStatusId<>3 and  (A2.AssetId =@id or  @id is null)) as t4

UNION
 select * from (	SELECT distinct
        Id,
        CI.Title Name,
        0 ParentId,
		 0 AS Level
		 ,'Purple' color
    FROM [SIMADB].AssetAndConfiguration.ConfigurationItem CI
    WHERE (id=@id or @id IS NULL) and ActiveStatusId<>3

) as t5)as aa)


SELECT @str = (
   
 select(
            SELECT distinct 
               cast( rowid as nvarchar) AS id,
                 name AS name,
                cast(@type as nvarchar) type,
                 id AS recordid,
                10 AS size,
                Color
            FROM CTe 
		
            FOR JSON PATH
        ) AS nodes
		,
        (
            SELECT distinct
                 cast(cc.rowid as nvarchar)  AS source,
              	cast(a2.rowid as nvarchar) AS target,
                 10 AS distance
            FROM CTe AS CC 
			 cross APPLY (
            SELECT  a2.rowid
            FROM CTe a2 
            WHERE a2.ParentId <> 0 
              AND a2.ParentId = cc.Id
        ) AS a2
	       where cc.Level=0
            FOR JSON PATH
        ) AS links
   

    FOR JSON PATH
);



set @str=REPLACE(REPLACE(REPLACE(@str,'\',''),'"{','{'),'}"','}')

 set @str='[{"data":'+@str+'}]'

select @str


END
